@using MenShopBlazor.DTOs.Collection
@using MenShopBlazor.DTOs.Product.ViewModel
@using MenShopBlazor.Services.Collection
@using MenShopBlazor.Services.Product
@inject ICollectionService CollectionService
@inject IProductService ProductService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudText>
            Tạo chi tiết bộ sưu tập
        </MudText>
        <MudGrid Class="mb-2">
            <MudItem xs="12" sm="7">
                <MudPaper Class="pa-4">
                    <MudAutocomplete T="ProductViewModel"
                                     Label="Sản phẩm"
                                     @bind-Value="selectedProduct"
                                     ToStringFunc="@(p => p?.ProductName)"
                                     SearchFunc="SearchProductsAutocomplete"
                                     Required="true"
                                     Class="mt-3" />

                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="AddProductToList" Class="mt-4">
                        Thêm vào danh sách
                    </MudButton>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="5">
                <MudPaper Class="pa-4 mud-height-full">
                    <MudText Typo="Typo.subtitle2">Danh sách sản phẩm đã chọn</MudText>
                    @if (tempProducts.Count == 0)
                    {
                        <MudText Typo="Typo.body2">Chưa có sản phẩm nào được thêm.</MudText>
                    }
                    else
                    {
                        <MudTable Items="@tempProducts">
                            <HeaderContent>
                                <MudTh>Tên sản phẩm</MudTh>
                                <MudTh></MudTh>
                            </HeaderContent>
                            <RowTemplate>
                                <MudTd>@context.ProductName</MudTd>
                                <MudTd>
                                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                   Color="Color.Error"
                                                   OnClick="@(() => RemoveProduct(context))" />
                                </MudTd>
                            </RowTemplate>
                        </MudTable>
                    }
                </MudPaper>
            </MudItem>
        </MudGrid>
    </DialogContent>

    <DialogActions>
        <MudButton Color="Color.Success" OnClick="SaveAllProducts" Disabled="@(tempProducts.Count == 0)">Lưu tất cả</MudButton>
        <MudButton OnClick="Cancel">Hủy</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] private IMudDialogInstance MudDialog { get; set; }
    [Parameter] public int collectionId { get; set; }

    private ProductViewModel selectedProduct;
    private List<ProductViewModel> productDTOs = new(); 
    private List<ProductViewModel> tempProducts = new();
    private List<CollectionDetailDTO> productDetails = new(); 
    private List<CollectionDTO> collectionDTOs = new(); // đảm bảo không null

    private bool _loading = false;

    protected override async Task OnInitializedAsync()
    {
        productDTOs = await ProductService.GetAllProductsAsync();
        await loadpage();
    }

    private async Task loadpage()
    {
        try
        {
            var result = await CollectionService.GetAllCollection();
            if (result == null || !result.Any())
            {
                Console.WriteLine("Không nhận được dữ liệu hoặc danh sách rỗng.");
            }
            else
            {
                Console.WriteLine($"Số lượng Collection: {result.Count}");
            }

            collectionDTOs = result ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Lỗi khi tải dữ liệu: " + ex.Message);
            collectionDTOs = new();
        }


    }


    private Task<IEnumerable<ProductViewModel>> SearchProductsAutocomplete(string value, CancellationToken token)
    {
        var alreadyAddedIds = tempProducts.Select(p => p.ProductId)
            .Concat(productDetails.Select(d => d.ProductId))
            .ToHashSet();

        var filtered = productDTOs
            .Where(p => !alreadyAddedIds.Contains(p.ProductId))
            .Where(p => string.IsNullOrWhiteSpace(value) || p.ProductName.Contains(value, StringComparison.OrdinalIgnoreCase));

        return Task.FromResult(filtered);
    }

    private void AddProductToList()
    {
        if (selectedProduct == null)
        {
            Snackbar.Add("Vui lòng chọn sản phẩm", Severity.Warning);
            return;
        }

        if (tempProducts.Any(p => p.ProductId == selectedProduct.ProductId))
        {
            Snackbar.Add("Sản phẩm đã có trong danh sách", Severity.Warning);
            return;
        }

        tempProducts.Add(selectedProduct);
        selectedProduct = null;
    }

    private void RemoveProduct(ProductViewModel product)
    {
        tempProducts.Remove(product);
    }

    private async Task SaveAllProducts()
    {
        bool hasError = false;

        foreach (var product in tempProducts)
        {
            var detailDto = new CreateCollectionDetailDTO
            {
                CollectionId = collectionId,
                ProductId = product.ProductId
            };

            var response = await CollectionService.AddCollectionDetail(detailDto);

            if (response.IsSuccess)
            {
                Snackbar.Add($"✔ {product.ProductName} - {response.Message}", Severity.Success);
                loadpage();
            }
            else
            {
                hasError = true;
                Snackbar.Add($"✘ {product.ProductName} - {response.Message}", Severity.Error);
                loadpage();
            }
        }

        tempProducts.Clear();
        await loadpage();

        if (!hasError)
        {
            MudDialog.Close(DialogResult.Ok(true));
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
        loadpage();
    }
}
