@page "/discount-price-detail/{id:int}"
@using MenShopBlazor.DTOs.DiscountPrice
@using MenShopBlazor.Services.DiscountPrice
@using MenShopBlazor.Shared
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject IDiscountPriceService DiscountPriceService
<MudOverlay Visible="_loading" DarkBackground="true" Fixed="true" ZIndex="1300">
    <MudProgressCircular Indeterminate="true" Color="Color.Primary" />
</MudOverlay>
<MudContainer Class="mt-5 px-8" MaxWidth="MaxWidth.False">
    <MudBreadcrumbs Items="_items"></MudBreadcrumbs>
    <MudGrid>
        <MudItem xs="12">
            <MudText Typo="Typo.h5" Class="mb-4">DANH SÁCH GIẢM GIÁ</MudText>

            @if (!_loading)
            {
                <MudDataGrid T="DiscountPriceDetailViewModel"
                             Items="@discountPriceViewModels"
                             RowsPerPage="7"
                             Dense="true"
                             Filterable="true"
                             FilterMode="DataGridFilterMode.ColumnFilterRow">
                    <Columns>
                        <PropertyColumn Property="x => x.Id" Filterable=false Title="Mã Chi Tiết" />
                        <PropertyColumn Property="x => x.discountPriceId" Filterable=false Title ="Mã Giảm Giá" />
                        <PropertyColumn Property="x => x.productDetailId" Filterable=false Title="Mã Chi Tiết Sản Phẩm" />
                        <PropertyColumn Property="x => x.ProductName" Title="Tên Sản Phẩm" />
                        <PropertyColumn Property="x => x.ColorName" Title="Màu" />
                        <PropertyColumn Property="x => x.SizeName" Title="Kích Cỡ" />
                        <PropertyColumn Property="x => x.FabricName" Title="Chất Liệu" />
                        <TemplateColumn Title="TÙY CHỈNH" TextAlign="DataGridColumnAlign.Right">
                            <CellTemplate>
                                <MudStack Row>
                                    @* <MudButton StartIcon="@Icons.Material.Outlined.Edit"
                                               Size="Size.Small"
                                               Color="Color.Primary"
                                               OnClick="@(() => OpenEditDialog(context.Item))">
                                        Sửa
                                    </MudButton> *@
                                    <MudButton StartIcon="@Icons.Material.Outlined.Delete"
                                               Size="Size.Small"
                                               Color="Color.Error"
                                               Class="ml-2"
                                               OnClick="@(() => DeleteColorAsync(context.Item.Id))">
                                        Xoá
                                    </MudButton>
                                </MudStack>
                            </CellTemplate>
                        </TemplateColumn>
                    </Columns>

                    <PagerContent>
                        <MudDataGridPager T="DiscountPriceDetailViewModel" />
                    </PagerContent>
                </MudDataGrid>

            }
        </MudItem>
    </MudGrid>
</MudContainer>
@code {
    [Parameter] public int id { get; set; }
    private List<DiscountPriceDetailViewModel> discountPriceViewModels = new();
    private List<BreadcrumbItem> _items = new();
    private bool _loading = false;
    protected override async Task OnInitializedAsync()
    {
        _items = new()
        {
            new BreadcrumbItem("Trang chủ", href: "/", icon: Icons.Material.Filled.Home),
            new BreadcrumbItem("Giảm giá", href: "/discountprice", icon: Icons.Material.Filled.List),
            new BreadcrumbItem("Chi tiết giảm giá", href: null, disabled: true, icon: Icons.Material.Filled.List),

        };
        await loadpage();
    }
    private async Task loadpage()
    {
        _loading = true;
        StateHasChanged();

        try
        {
            var result = await DiscountPriceService.GetAllProductDetailDiscountPrice(id);
            if (result == null || !result.Any())
            {
                Console.WriteLine("Không nhận được dữ liệu hoặc danh sách rỗng.");
            }
            else
            {
                Console.WriteLine($"Số lượng giảm giá: {result.Count}");
            }

            discountPriceViewModels = result ?? new();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Lỗi khi tải dữ liệu: " + ex.Message);
            discountPriceViewModels = new();
        }

        _loading = false;
        StateHasChanged();
    }
    private async Task DeleteColorAsync(int id)
    {
        var parameters = new DialogParameters
        {
            { "ContentText", $"Bạn có chắc muốn xoá khuyến mãi có ID = {id} không?" },
            { "ButtonText", "Xoá" },
            { "Color", Color.Error }
        };

        var options = new DialogOptions { CloseButton = true, MaxWidth = MaxWidth.ExtraSmall };
        var dialog = DialogService.Show<ConfirmDeleteDialog>("Xác nhận xoá", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var response = await DiscountPriceService.DeleteDiscountPriceDetailAsync(id);

            if (response.IsSuccess)
            {
                Snackbar.Add("Xóa khuyến mãi thành công", Severity.Success);
            }
            else
            {
                Snackbar.Add(response.Message, Severity.Error);
            }

            await loadpage();
        }
    }

}
